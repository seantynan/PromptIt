<script>
const list = document.getElementById('promptlet-list');

// Helper: ensure defaults exist
function ensureDefaults(callback) {
  chrome.storage.local.get({ promptlets: [] }, (data) => {
    if (!data.promptlets || data.promptlets.length === 0) {
      const defaultPromptlets = [
        { name: "Summarize", emoji: "ðŸ’¡", prompt: "Summarize this text clearly and concisely." },
        { name: "Rephrase", emoji: "âœï¸", prompt: "Rephrase this text to improve clarity and flow." }
      ];
      chrome.storage.local.set({ promptlets: defaultPromptlets }, () => {
        callback(defaultPromptlets);
      });
    } else {
      callback(data.promptlets);
    }
  });
}

// Render promptlets in the popup
function renderPromptlets(promptlets) {
  list.innerHTML = "";
  promptlets.forEach(p => {
    const li = document.createElement('li');
    li.textContent = `${p.emoji || ''} ${p.name}`;
    li.dataset.promptlet = p.name;
    li.addEventListener('click', () => {
      chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => {
        const tab = tabs[0];
        chrome.scripting.executeScript({
          target: { tabId: tab.id },
          func: () => window.getSelection().toString()
        }, (results) => {
          const selectionText = results && results[0] ? results[0].result : '';
          chrome.runtime.sendMessage({
            action: 'runPromptlet',
            name: p.name,
            tabId: tab.id,
            text: selectionText
          });
          window.close();
        });
      });
    });
    list.appendChild(li);
  });
}

// Initialize
ensureDefaults(renderPromptlets);
</script>
